<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="theme-color" content="#ff6a00" />
<title>PDV Bebidas ‚Ä¢ Turbo</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00; --dark:#0f172a; --bg:#f4f6fb; --card:#fff;
  --border:#e5e7eb; --muted:#64748b; --radius:16px; --shadow:0 10px 26px rgba(0,0,0,.12);
  --green:#16a34a;
}
*{box-sizing:border-box;font-family:Inter,system-ui}
body{margin:0;background:var(--bg);color:#0f172a}
header{position:sticky;top:0;z-index:20;background:var(--dark);color:#fff;padding:12px 14px;font-weight:900}
main{padding:12px;display:grid;gap:12px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--border);padding:12px}
.grid-comandas{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.comanda{
  padding:12px;border-radius:14px;border:2px solid var(--border);
  text-align:center;font-weight:800;background:#fff;cursor:pointer;user-select:none
}
.comanda.active{border-color:var(--primary);box-shadow:0 0 0 2px rgba(255,106,0,.2)}
.comanda.has-items{background:#ecfdf5;border-color:var(--green)}
.comanda .total{font-size:12px;color:#16a34a;margin-top:4px}

.produtos{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.produto{
  position:relative;padding:12px;border-radius:14px;border:2px solid var(--border);
  background:#fff;cursor:pointer
}
.produto.selected{border-color:var(--primary)}
.badge{position:absolute;top:-6px;right:-6px;background:var(--primary);color:#fff;border-radius:999px;padding:4px 8px;font-weight:900}

.carrinho{margin-top:6px}
.item{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed var(--border)}
.qty{display:flex;align-items:center;gap:6px}
.qty button{border:none;background:#e5e7eb;border-radius:8px;padding:6px 10px;font-weight:900}

.total-box{background:linear-gradient(135deg,#ff6a00,#f97316);color:#fff;border-radius:14px;padding:12px;text-align:center;font-size:22px;font-weight:900}
.btn{padding:14px;border-radius:14px;border:none;font-weight:900;cursor:pointer}
.btn.primary{background:var(--primary);color:#fff}
.btn.gray{background:#e5e7eb}
.btn.danger{background:#dc2626;color:#fff}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-end;z-index:50}
.modal .box{background:#fff;border-radius:18px 18px 0 0;padding:14px;max-height:85vh;overflow:auto}
.modal.show{display:flex}
</style>
</head>
<body>

<header>PDV Bebidas ‚Ä¢ Turbo</header>

<main>

  <div class="card">
    <h2>üßæ Comandas</h2>
    <div class="grid-comandas" id="listaComandas"></div>
  </div>

  <div class="card">
    <h2>üçª Produtos</h2>
    <div class="produtos" id="produtos"></div>
  </div>

  <div class="card">
    <h2>üìå Itens para lan√ßar</h2>
    <div class="carrinho" id="carrinho"></div>
    <div class="total-box">Total: R$ <span id="total">0.00</span></div>
    <button class="btn primary" onclick="lancarNaComanda()">Lan√ßar itens na comanda</button>
  </div>

</main>

<!-- MODAL DE CONFER√äNCIA / FECHAMENTO -->
<div class="modal" id="modal">
  <div class="box">
    <h3>üßæ Confer√™ncia da Comanda</h3>
    <div id="modalItens"></div>
    <div class="total-box">Total: R$ <span id="modalTotal">0.00</span></div>

    <div style="margin-top:10px">
      <button class="btn gray" onclick="fecharModal()">Voltar</button>
      <button class="btn danger" onclick="mostrarPagamentos()">Fechar Conta</button>
    </div>

    <div id="pagamentos" style="display:none;margin-top:10px">
      <button class="btn gray" onclick="confirmarFechamento('PIX')">PIX</button>
      <button class="btn gray" onclick="confirmarFechamento('Cr√©dito')">Cr√©dito</button>
      <button class="btn gray" onclick="confirmarFechamento('D√©bito')">D√©bito</button>
      <button class="btn gray" onclick="confirmarFechamento('Dinheiro')">Dinheiro</button>
    </div>
  </div>
</div>

<script>
const sb = window.supabase.createClient(
  "https://jpbmilzeydcovghkrtfp.supabase.co",
  "sb_publishable_H_F8x9-SerZW41cWUBdy6g_Ksb-XugW"
);

let produtos=[], comandas=[], comandaAtual=null;
let carrinhoTemp=[]; // itens selecionados antes de lan√ßar
let carrinhoPorComanda={};

async function init(){
  const { data: c } = await sb.from("comandas").select("id,nome,status").order("nome");
  comandas = c || [];
  const { data: p } = await sb.from("produtos_turbo").select("id,nome,preco_venda").eq("ativo",true).order("nome");
  produtos = p || [];
  renderComandas(); renderProdutos();
}

function renderComandas(){
  document.getElementById("listaComandas").innerHTML = comandas.map(c=>{
    const itens = carrinhoPorComanda[c.id]||[];
    const total = itens.reduce((s,i)=>s+i.qtd*i.preco_venda,0);
    return `
      <div class="comanda ${comandaAtual?.id===c.id?'active':''} ${total>0?'has-items':''}"
           onclick="selecionarComanda('${c.id}')"
           oncontextmenu="abrirModal('${c.id}');return false;">
        ${c.nome}
        ${total>0?`<div class="total">R$ ${total.toFixed(2)}</div>`:''}
      </div>`;
  }).join("");
}

function renderProdutos(){
  document.getElementById("produtos").innerHTML = produtos.map(p=>{
    const item = carrinhoTemp.find(i=>i.id===p.id);
    const qtd = item?item.qtd:0;
    return `
      <div class="produto ${qtd?'selected':''}" onclick="addTemp('${p.id}')">
        ${qtd?`<span class="badge">${qtd}</span>`:''}
        <b>${p.nome}</b>
        <div>R$ ${Number(p.preco_venda).toFixed(2)}</div>
      </div>`;
  }).join("");
}

function renderCarrinho(){
  let total=0;
  document.getElementById("carrinho").innerHTML = carrinhoTemp.map((i,idx)=>{
    const sub=i.qtd*i.preco_venda; total+=sub;
    return `
      <div class="item">
        <span>${i.nome}</span>
        <div class="qty">
          <button onclick="alterarQtd(${idx},-1)">-</button>
          <b>${i.qtd}</b>
          <button onclick="alterarQtd(${idx},1)">+</button>
        </div>
        <strong>R$ ${sub.toFixed(2)}</strong>
      </div>`;
  }).join("");
  document.getElementById("total").innerText = total.toFixed(2);
}

function selecionarComanda(id){ comandaAtual=comandas.find(c=>c.id===id); renderComandas(); }
function addTemp(id){
  if(!comandaAtual) return alert("Selecione uma comanda");
  const p = produtos.find(x=>x.id===id);
  const ex = carrinhoTemp.find(x=>x.id===id);
  if(ex) ex.qtd++; else carrinhoTemp.push({...p,qtd:1});
  renderProdutos(); renderCarrinho();
}
function alterarQtd(i,delta){
  carrinhoTemp[i].qtd+=delta;
  if(carrinhoTemp[i].qtd<=0) carrinhoTemp.splice(i,1);
  renderProdutos(); renderCarrinho();
}
function lancarNaComanda(){
  if(!comandaAtual) return alert("Selecione a comanda");
  carrinhoPorComanda[comandaAtual.id] = carrinhoPorComanda[comandaAtual.id] || [];
  carrinhoTemp.forEach(it=>{
    const ex = carrinhoPorComanda[comandaAtual.id].find(x=>x.id===it.id);
    if(ex) ex.qtd += it.qtd;
    else carrinhoPorComanda[comandaAtual.id].push({...it});
  });
  carrinhoTemp=[]; renderCarrinho(); renderProdutos(); renderComandas();
}

function abrirModal(id){
  comandaAtual = comandas.find(c=>c.id===id);
  const itens = carrinhoPorComanda[id]||[];
  let total=0;
  document.getElementById("modalItens").innerHTML = itens.map(i=>{
    const sub=i.qtd*i.preco_venda; total+=sub;
    return `<div class="item"><span>${i.nome} x ${i.qtd}</span><strong>R$ ${sub.toFixed(2)}</strong></div>`;
  }).join("");
  document.getElementById("modalTotal").innerText = total.toFixed(2);
  document.getElementById("modal").classList.add("show");
}
function fecharModal(){ document.getElementById("modal").classList.remove("show"); document.getElementById("pagamentos").style.display='none'; }
function mostrarPagamentos(){ document.getElementById("pagamentos").style.display='block'; }

async function confirmarFechamento(forma){
  const itens = carrinhoPorComanda[comandaAtual.id]||[];
  for(const item of itens){
    await sb.from("vendas_bebidas").insert({
      produto_id:item.id,nome_produto:item.nome,quantidade:item.qtd,
      preco_unitario:item.preco_venda,total:item.qtd*item.preco_venda,
      forma_pagamento:forma, comanda_id:comandaAtual.id
    });
  }
  await sb.from("comandas").update({status:'FECHADA'}).eq("id",comandaAtual.id);
  carrinhoPorComanda[comandaAtual.id]=[];
  fecharModal(); renderComandas();
  alert("Conta fechada!");
}

init();
</script>

</body>
</html>
